<!DOCTYPE html>
<!--
  This is a minimal example of using wa-sqlite. In production, code will
  likely be bundled, resolving the ES6 module imports. Bundling is not
  done here to avoid that additional complication, but this means that
  the bare module specifiers need special handling to work as-is.

  Chrome supports the Import Maps proposal to handle bare module
  specifiers. For other browsers (which will ignore the import map below)
  you will need to edit the import paths or use a server (e.g.
  https://modern-web.dev/docs/dev-server/overview/) that automatically
  rewrites them.
-->
<script type="importmap">
  {
    "imports": {
      "wa-sqlite": "../src/sqlite-api.js",
      "wa-sqlite/debug/wa-sqlite.mjs": "../debug/wa-sqlite.mjs",
      "wa-sqlite/debug/wa-sqlite-async.mjs": "../debug/wa-sqlite-async.mjs",
      "wa-sqlite/debug/wa-sqlite-jspi.mjs": "../debug/wa-sqlite-jspi.mjs"
    }
  }
</script>

<script type="module">
  // import SQLiteESMFactory from 'wa-sqlite/debug/wa-sqlite.mjs';
  import SQLiteESMFactory from 'wa-sqlite/debug/wa-sqlite-jspi.mjs';
  // import SQLiteESMFactory from 'wa-sqlite/debug/wa-sqlite-async.mjs';

  import * as SQLite from 'wa-sqlite';
  import { MemoryVFS } from '../src/examples/MemoryVFS.js';

  async function hello() {
    const module = await SQLiteESMFactory();
    const sqlite3 = SQLite.Factory(module);

    sqlite3.vfs_register(new MemoryVFS('test', module), true);
    const db = await sqlite3.open_v2('test.db');
    await sqlite3.exec(db, `SELECT 'Hello, world!'`, (row, columns) => {
      console.log(row);
      document.body.textContent = JSON.stringify(row[0]);
    });

    await sqlite3.exec(db, `
      PRAGMA cache_size=0;
      CREATE TABLE IF NOT EXISTS t(x);
      INSERT INTO t VALUES ('how'), ('now'), ('brown'), ('cow');
      SELECT * FROM t;
    `, (row, columns) => {
      console.log(row);
    });
    await sqlite3.close(db);

    // const ptr = module._malloc(4);
    // result = await module.ccall(
    //   'sqlite3_open_v2',
    //   'number',
    //   ['string', 'number', 'number', 'string'],
    //   ['hello.db', ptr, SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, 'test'],
    //   { async: true });
    // console.log('sqlite3_open_v2', result, module.getValue(ptr, 'i32'));
  }

  hello();
</script>